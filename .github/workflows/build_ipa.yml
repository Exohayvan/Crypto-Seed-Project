name: Build IPA

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: macos-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up Python 3.8
      uses: actions/setup-python@v2
      with:
        python-version: 3.8

    - name: Install dependencies
      run: |
        pip install kivy
        pip install git+https://github.com/kivy/kivy-ios.git
        pip install -r requirements.txt

    - name: Install system dependencies
      run: |
        brew install autoconf automake libtool pkg-config
        brew link libtool

    - name: Cache Kivy-ios toolchain
      uses: actions/cache@v2
      id: kivy-ios-cache
      with:
        path: kivy_ios_venv
        key: ${{ runner.os }}-kivy-ios-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-kivy-ios-

    - name: Build the Kivy-ios toolchain
      if: steps.kivy-ios-cache.outputs.cache-hit != 'true'
      run: |
        python -m venv kivy_ios_venv
        source kivy_ios_venv/bin/activate
        pip install --upgrade pip
        pip install cython==0.29.17
        pip install git+https://github.com/kivy/kivy-ios.git
        kivy_ios_venv/bin/python -m kivy_ios.toolchain build python3
        kivy_ios_venv/bin/python -m kivy_ios.toolchain create mykivyapp-ios mykivyapp-ios
        cp main.py mykivyapp-ios/mykivyapp/main.py
        kivy_ios_venv/bin/python -m kivy_ios.toolchain update mykivyapp-ios
        deactivate

    - name: Build IPA
      run: |
        cd mykivyapp-ios
        xcodebuild archive -scheme mykivyapp -archivePath mykivyapp.xcarchive
        xcodebuild -exportArchive -archivePath mykivyapp.xcarchive -exportOptionsPlist ExportOptions.plist -exportPath ./IPA

    - name: Upload IPA as artifact
      uses: actions/upload-artifact@v2
      with:
        name: MyKivyApp
        path: mykivyapp-ios/IPA/mykivyapp.ipa
